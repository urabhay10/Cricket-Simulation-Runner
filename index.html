<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NextGen Cricket Simulator</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@400;600;800&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: #e2e8f0; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        
        .suggestion-active {
            background-color: #334155;
            border-left: 4px solid #10b981;
        }

        .ball-pop {
            animation: pop 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @keyframes pop {
            0% { transform: scale(0.8); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }

        /* Fixed Layout Table Styles */
        .score-table {
            table-layout: fixed;
            width: 100%;
        }
        /* Align headers and cells strictly */
        .score-table th { 
            @apply text-[10px] uppercase tracking-wider text-slate-500 font-semibold py-3 px-2 border-b border-slate-700/50 bg-slate-900/50; 
        }
        .score-table td { 
            @apply py-2.5 px-2 text-sm border-b border-slate-800/50; 
        }
        
        /* Alignment Utilities */
        .text-r { text-align: right; }
        .text-l { text-align: left; }
        .text-c { text-align: center; }

        .score-table tr:last-child td { border-bottom: none; }
        .score-table tr:hover { background-color: rgba(30, 41, 59, 0.5); }
        
        /* Predictor Bar Animation */
        .prob-bar {
            transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const PlayerInput = ({ value, onChange, placeholder, className }) => {
            const [suggestions, setSuggestions] = useState([]);
            const [show, setShow] = useState(false);
            const [selectedIndex, setSelectedIndex] = useState(-1);
            const listRef = useRef(null);

            const handleInputChange = (e) => {
                const text = e.target.value;
                onChange(text);
                if (text.length >= 1) {
                    fetch(`http://127.0.0.1:8000/players/search?q=${text}`)
                        .then(res => res.json())
                        .then(data => {
                            setSuggestions(data);
                            setShow(true);
                            setSelectedIndex(-1);
                        })
                        .catch(err => console.error(err));
                } else {
                    setSuggestions([]);
                    setShow(false);
                }
            };

            const handleSelect = (player) => {
                if (!player) return;
                onChange(player.name);
                setShow(false);
                setSuggestions([]);
                setSelectedIndex(-1);
            };

            const handleKeyDown = (e) => {
                if (!show || suggestions.length === 0) return;
                if (e.key === "ArrowDown") {
                    e.preventDefault();
                    setSelectedIndex(prev => (prev < suggestions.length - 1 ? prev + 1 : prev));
                } else if (e.key === "ArrowUp") {
                    e.preventDefault();
                    setSelectedIndex(prev => (prev > 0 ? prev - 1 : prev));
                } else if (e.key === "Enter") {
                    e.preventDefault();
                    if (selectedIndex >= 0 && suggestions[selectedIndex]) {
                        handleSelect(suggestions[selectedIndex]);
                    }
                } else if (e.key === "Escape") {
                    setShow(false);
                }
            };

            return (
                <div className="relative w-full">
                    <input
                        type="text"
                        className={className || "w-full bg-slate-800 border border-slate-700 rounded p-2 text-sm focus:border-emerald-500 focus:outline-none transition-colors text-white"}
                        placeholder={placeholder}
                        value={value}
                        onChange={handleInputChange}
                        onKeyDown={handleKeyDown}
                        onBlur={() => setTimeout(() => setShow(false), 200)}
                    />
                    {show && suggestions.length > 0 && (
                        <ul ref={listRef} className="absolute z-50 w-full bg-slate-800 border border-slate-700 mt-1 rounded max-h-48 overflow-y-auto shadow-xl scrollbar-hide">
                            {suggestions.map((s, i) => (
                                <li key={i} 
                                    className={`p-2 hover:bg-slate-700 cursor-pointer text-sm border-b border-slate-700/50 flex justify-between transition-colors ${i === selectedIndex ? 'suggestion-active bg-slate-700' : ''}`}
                                    onMouseEnter={() => setSelectedIndex(i)}
                                    onClick={() => handleSelect(s)}>
                                    <span className="text-white">{s.name}</span>
                                    <span className={`text-xs px-2 py-0.5 rounded h-fit ${s.role === 'Bowler' ? 'bg-rose-900/50 text-rose-300' : 'bg-emerald-900/50 text-emerald-300'}`}>
                                        {s.role}
                                    </span>
                                </li>
                            ))}
                        </ul>
                    )}
                </div>
            );
        };

        const BallPredictor = ({ onBack }) => {
            const [form, setForm] = useState({
                innings: 1,
                over: 19,
                ball: 1,
                total_runs: 150,
                wickets: 4,
                striker_name: "V Kohli",
                bowler_name: "MA Starc",
                target: ""
            });
            const [result, setResult] = useState(null);
            const [loading, setLoading] = useState(false);

            const handleChange = (field, val) => {
                setForm(prev => ({ ...prev, [field]: val }));
            };

            // Keyboard shortcut for predict button (Ctrl+Enter or Cmd+Enter)
            useEffect(() => {
                const handleKeyPress = (e) => {
                    if ((e.ctrlKey || e.metaKey) && e.key === 'Enter' && !loading) {
                        e.preventDefault();
                        handlePredict();
                    }
                };
                window.addEventListener('keydown', handleKeyPress);
                return () => window.removeEventListener('keydown', handleKeyPress);
            }, [loading, form]);

            const handlePredict = async () => {
                setLoading(true);
                setResult(null);
                try {
                    const payload = {
                        ...form,
                        target: form.innings === 2 && form.target ? parseInt(form.target) : null
                    };

                    const response = await fetch('http://127.0.0.1:8000/predict_ball', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    const data = await response.json();
                    setResult(data);
                } catch (error) {
                    console.error(error);
                    alert("Prediction Failed: Check API connection");
                } finally {
                    setLoading(false);
                }
            };

            const outcomeColors = {
                "0": "bg-slate-500",
                "1": "bg-blue-500",
                "2": "bg-cyan-500",
                "3": "bg-teal-500",
                "4": "bg-emerald-500",
                "6": "bg-purple-500",
                "Wicket": "bg-rose-500"
            };

            return (
                <div className="min-h-screen p-6 flex flex-col items-center animate-fade-in max-w-4xl mx-auto w-full">
                    {/* Header */}
                    <div className="w-full flex justify-between items-center mb-8">
                         <button onClick={onBack} className="text-xs font-bold text-slate-500 hover:text-white flex items-center gap-2 px-4 py-2 rounded-full bg-slate-900 border border-slate-800 transition hover:border-slate-600">
                            <i data-lucide="arrow-left" className="w-4 h-4"></i> BACK TO SIMULATOR
                        </button>
                        <h1 className="text-2xl font-black bg-gradient-to-r from-purple-400 to-pink-500 bg-clip-text text-transparent uppercase tracking-tight">AI Ball Predictor</h1>
                    </div>

                    <div className="grid md:grid-cols-2 gap-8 w-full">
                        {/* Input Section */}
                        <div className="bg-slate-900 p-6 rounded-2xl border border-slate-800 shadow-xl space-y-6">
                            <div className="flex justify-between items-center border-b border-slate-800 pb-4">
                                <h2 className="font-bold text-white flex items-center gap-2"><i data-lucide="sliders" className="w-4 h-4 text-purple-400"></i> Match State</h2>
                            </div>
                            
                            <div className="grid grid-cols-2 gap-4">
                                <div>
                                    <label className="text-[10px] uppercase font-bold text-slate-500 mb-1 block">Innings</label>
                                    <select 
                                        value={form.innings} 
                                        onChange={(e) => handleChange('innings', parseInt(e.target.value))}
                                        className="w-full bg-slate-800 border border-slate-700 rounded p-2 text-sm text-white focus:border-purple-500 outline-none"
                                    >
                                        <option value={1}>1st Innings</option>
                                        <option value={2}>2nd Innings</option>
                                    </select>
                                </div>
                                <div>
                                    <label className="text-[10px] uppercase font-bold text-slate-500 mb-1 block">Target (Runs)</label>
                                    <input 
                                        type="number" 
                                        disabled={form.innings === 1}
                                        value={form.target} 
                                        onChange={(e) => handleChange('target', e.target.value)}
                                        className="w-full bg-slate-800 border border-slate-700 rounded p-2 text-sm text-white focus:border-purple-500 outline-none disabled:opacity-30"
                                        placeholder={form.innings === 1 ? "-" : "e.g. 180"}
                                    />
                                </div>
                            </div>

                            <div className="grid grid-cols-3 gap-4">
                                <div>
                                    <label className="text-[10px] uppercase font-bold text-slate-500 mb-1 block">Over (0-19)</label>
                                    <input type="number" value={form.over} onChange={(e) => handleChange('over', parseInt(e.target.value))} className="w-full bg-slate-800 border border-slate-700 rounded p-2 text-sm text-white focus:border-purple-500 outline-none" />
                                </div>
                                <div>
                                    <label className="text-[10px] uppercase font-bold text-slate-500 mb-1 block">Ball (1-6)</label>
                                    <input type="number" value={form.ball} onChange={(e) => handleChange('ball', parseInt(e.target.value))} className="w-full bg-slate-800 border border-slate-700 rounded p-2 text-sm text-white focus:border-purple-500 outline-none" />
                                </div>
                                <div>
                                    <label className="text-[10px] uppercase font-bold text-slate-500 mb-1 block">Wickets</label>
                                    <input type="number" value={form.wickets} onChange={(e) => handleChange('wickets', parseInt(e.target.value))} className="w-full bg-slate-800 border border-slate-700 rounded p-2 text-sm text-white focus:border-purple-500 outline-none" />
                                </div>
                            </div>

                            <div>
                                <label className="text-[10px] uppercase font-bold text-slate-500 mb-1 block">Current Score</label>
                                <input type="number" value={form.total_runs} onChange={(e) => handleChange('total_runs', parseInt(e.target.value))} className="w-full bg-slate-800 border border-slate-700 rounded p-2 text-sm text-white focus:border-purple-500 outline-none" />
                            </div>

                            <div className="space-y-4 pt-2 border-t border-slate-800">
                                <div>
                                    <label className="text-[10px] uppercase font-bold text-emerald-500 mb-1 block">Striker</label>
                                    <PlayerInput 
                                        value={form.striker_name} 
                                        onChange={(v) => handleChange('striker_name', v)} 
                                        placeholder="Enter Batter Name"
                                        className="w-full bg-slate-800 border border-emerald-500/30 rounded p-2 text-sm text-white focus:border-emerald-500 outline-none"
                                    />
                                </div>
                                <div>
                                    <label className="text-[10px] uppercase font-bold text-rose-500 mb-1 block">Bowler</label>
                                    <PlayerInput 
                                        value={form.bowler_name} 
                                        onChange={(v) => handleChange('bowler_name', v)} 
                                        placeholder="Enter Bowler Name"
                                        className="w-full bg-slate-800 border border-rose-500/30 rounded p-2 text-sm text-white focus:border-rose-500 outline-none"
                                    />
                                </div>
                            </div>

                            <button 
                                onClick={handlePredict} 
                                disabled={loading}
                                className="w-full py-4 rounded-xl bg-gradient-to-r from-purple-600 to-pink-600 font-bold text-white shadow-lg hover:scale-[1.02] active:scale-[0.98] transition-all disabled:opacity-50 disabled:cursor-not-allowed flex justify-center items-center gap-2"
                            >
                                {loading ? <i data-lucide="loader" className="w-5 h-5 animate-spin"></i> : <i data-lucide="zap" className="w-5 h-5"></i>}
                                PREDICT OUTCOME
                                <span className="text-xs opacity-70 ml-2">(Ctrl+Enter)</span>
                            </button>
                        </div>

                        {/* Result Section */}
                        <div className="flex flex-col gap-6">
                            {result ? (
                                <>
                                    <div className="bg-slate-900 p-6 rounded-2xl border border-slate-800 shadow-xl relative overflow-hidden">
                                        <div className="absolute top-0 right-0 w-32 h-32 bg-purple-500/10 rounded-full blur-3xl -mr-10 -mt-10"></div>
                                        <h3 className="text-slate-400 font-bold text-xs uppercase tracking-widest mb-6">Probability Distribution</h3>
                                        
                                        <div className="space-y-4">
                                            {Object.entries(result.distribution).map(([outcome, prob]) => {
                                                const percentage = (prob * 100).toFixed(1);
                                                const isMax = Math.max(...Object.values(result.distribution)) === prob;
                                                
                                                return (
                                                    <div key={outcome} className="group">
                                                        <div className="flex justify-between text-sm mb-1">
                                                            <span className={`font-bold ${outcome === 'Wicket' ? 'text-rose-400' : outcome === '6' || outcome === '4' ? 'text-emerald-400' : 'text-slate-300'}`}>
                                                                {outcome === 'Wicket' ? 'WICKET' : outcome + (outcome === '1' ? ' Run' : ' Runs')}
                                                            </span>
                                                            <span className="font-mono text-slate-400">{percentage}%</span>
                                                        </div>
                                                        <div className="h-2 w-full bg-slate-800 rounded-full overflow-hidden">
                                                            <div 
                                                                className={`h-full rounded-full prob-bar ${outcomeColors[outcome] || 'bg-slate-500'} ${isMax ? 'shadow-[0_0_10px_currentColor]' : ''}`} 
                                                                style={{ width: `${percentage}%`, opacity: isMax ? 1 : 0.7 }}
                                                            ></div>
                                                        </div>
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    </div>

                                    <div className="bg-slate-900/50 p-4 rounded-xl border border-slate-800 flex justify-between items-center text-xs text-slate-500">
                                        <div className="flex flex-col gap-1">
                                            <span className="uppercase tracking-widest font-bold">Resolved As</span>
                                        </div>
                                        <div className="text-right flex gap-4">
                                            <div>
                                                <div className="text-emerald-400 font-bold">{result.striker_resolved}</div>
                                                <div>Striker</div>
                                            </div>
                                            <div>
                                                <div className="text-rose-400 font-bold">{result.bowler_resolved}</div>
                                                <div>Bowler</div>
                                            </div>
                                        </div>
                                    </div>
                                </>
                            ) : (
                                <div className="h-full flex flex-col items-center justify-center text-slate-600 bg-slate-900/30 rounded-2xl border border-slate-800/50 border-dashed">
                                    <i data-lucide="bar-chart-2" className="w-12 h-12 mb-4 opacity-50"></i>
                                    <p className="text-sm font-medium">Enter match details to predict</p>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        const ScoreCardLive = ({ detail, live }) => {
            if (!detail) return null;
            const { striker, non_striker, bowler, total_runs = 0, wickets = 0, bat_team = "", target, over = 0, ball = 0 } = detail || {};
            
            const ballsDone = over * 6 + ball;
            const crr = ballsDone > 0 ? ((total_runs / ballsDone) * 6).toFixed(2) : "0.00";
            let rrr = null;
            if (target) {
                const ballsRem = 120 - ballsDone;
                const runsRem = target - total_runs;
                rrr = ballsRem > 0 ? ((runsRem / ballsRem) * 6).toFixed(2) : "-";
            }

            return (
                <div className="bg-gradient-to-br from-slate-800 to-slate-900 rounded-2xl p-6 shadow-2xl border border-slate-700 mb-6 relative overflow-hidden">
                    {live && <div className="absolute top-4 right-4 flex items-center gap-2">
                        <span className="animate-pulse w-3 h-3 bg-red-500 rounded-full shadow-[0_0_10px_rgba(239,68,68,0.6)]"></span>
                        <span className="text-xs font-bold text-red-500 uppercase tracking-widest">Live</span>
                    </div>}
                    
                    {/* Main Score Display */}
                    <div className="flex flex-col items-center justify-center mb-8 relative z-10">
                        <div className="text-sm text-emerald-400 uppercase tracking-[0.2em] font-bold mb-2">{bat_team} Batting</div>
                        <div className="text-7xl font-black font-mono tracking-tighter text-white drop-shadow-lg leading-none">
                            {total_runs}<span className="text-slate-600 mx-2 text-5xl font-light">/</span>{wickets}
                        </div>
                        <div className="text-slate-400 font-mono mt-3 text-lg bg-slate-950/30 px-4 py-1 rounded-full border border-white/5">
                            Overs: <span className="text-white font-bold">{over}.{ball}</span>
                        </div>
                        
                        <div className="flex gap-12 mt-8 w-full justify-center border-t border-white/5 pt-6">
                            <div className="text-center">
                                <div className="text-[10px] uppercase text-slate-500 font-bold tracking-widest mb-1">CRR</div>
                                <div className="text-2xl font-mono text-emerald-400 font-bold">{crr}</div>
                            </div>
                            {target && (
                                <>
                                <div className="text-center px-8 border-x border-white/5">
                                    <div className="text-[10px] uppercase text-slate-500 font-bold tracking-widest mb-1">Target</div>
                                    <div className="text-2xl font-mono text-white font-bold">{target}</div>
                                </div>
                                <div className="text-center">
                                    <div className="text-[10px] uppercase text-slate-500 font-bold tracking-widest mb-1">RRR</div>
                                    <div className="text-2xl font-mono text-rose-400 font-bold">{rrr}</div>
                                </div>
                                </>
                            )}
                        </div>
                    </div>

                    {/* Active Players Grid */}
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4 relative z-10">
                        {/* Batting Card */}
                        <div className="bg-slate-950/40 p-5 rounded-xl border border-white/5 backdrop-blur-sm shadow-inner">
                            <div className="text-[10px] text-slate-500 uppercase mb-4 flex items-center gap-2 font-bold tracking-wider border-b border-white/5 pb-2">
                                <i data-lucide="users" className="w-3 h-3"></i> Batting
                            </div>
                            {striker && (
                                <div className="flex justify-between items-center mb-3">
                                    <div className="flex items-center gap-3">
                                        <div className="w-1.5 h-1.5 bg-emerald-500 rounded-full animate-pulse"></div>
                                        <span className="font-bold text-white text-lg tracking-tight">{striker.name}</span>
                                    </div>
                                    <div className="font-mono text-emerald-400 text-xl font-bold">{striker.runs}<span className="text-slate-500 text-sm ml-1 font-medium">({striker.balls})</span></div>
                                </div>
                            )}
                            {non_striker && (
                                <div className="flex justify-between items-center opacity-60">
                                    <span className="text-slate-300 font-medium pl-4.5">{non_striker.name}</span>
                                    <span className="font-mono text-slate-400">{non_striker.runs}<span className="text-slate-600 text-sm ml-1">({non_striker.balls})</span></span>
                                </div>
                            )}
                        </div>

                        {/* Bowling Card */}
                        <div className="bg-slate-950/40 p-5 rounded-xl border border-white/5 backdrop-blur-sm shadow-inner">
                             <div className="text-[10px] text-slate-500 uppercase mb-4 flex items-center gap-2 font-bold tracking-wider border-b border-white/5 pb-2">
                                <i data-lucide="crosshair" className="w-3 h-3"></i> Bowling
                            </div>
                            {bowler && (
                                <div>
                                    <div className="flex justify-between items-center mb-4">
                                        <span className="font-bold text-rose-300 text-lg tracking-tight">{bowler.name}</span>
                                    </div>
                                    <div className="grid grid-cols-3 gap-2">
                                        <div className="bg-slate-800/50 rounded p-1 text-center border border-white/5">
                                            <div className="text-[9px] text-slate-500 uppercase font-bold">Wickets</div>
                                            <div className="font-mono font-bold text-white text-lg">{bowler.wickets}</div>
                                        </div>
                                        <div className="bg-slate-800/50 rounded p-1 text-center border border-white/5">
                                            <div className="text-[9px] text-slate-500 uppercase font-bold">Runs</div>
                                            {/* Server uses 'runs_given' in the live feed for bowler stats */}
                                            <div className="font-mono text-slate-300 text-lg">{bowler.runs_given ?? bowler.runs ?? 0}</div>
                                        </div>
                                        <div className="bg-slate-800/50 rounded p-1 text-center border border-white/5">
                                            <div className="text-[9px] text-slate-500 uppercase font-bold">Overs</div>
                                            <div className="font-mono text-slate-300 text-lg">{bowler.overs}.{ball}</div>
                                        </div>
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        const Commentary = ({ events }) => {
            const scrollRef = useRef(null);
            const [isAutoScroll, setIsAutoScroll] = useState(true);

            useEffect(() => {
                if (isAutoScroll && scrollRef.current) {
                    const { scrollHeight, clientHeight } = scrollRef.current;
                    scrollRef.current.scrollTo({ top: scrollHeight, behavior: 'smooth' });
                }
            }, [events, isAutoScroll]);

            const groupedOvers = [];
            events.forEach(e => {
                if (!e || typeof e.over === 'undefined') return;
                
                // CRITICAL FIX: Include match_no in the key to prevent overs from different matches merging
                const matchPrefix = e.match_no ? `M${e.match_no}-` : '';
                const key = `${matchPrefix}${e.innings}-${e.over}`;
                
                let over = groupedOvers.find(o => o.key === key);
                if (!over) {
                    over = { key: key, team: e.bat_team, balls: [], runs: e.total_runs, wickets: e.wickets, overNum: e.over + 1 };
                    groupedOvers.push(over);
                }
                over.balls.push(e.is_wicket ? 'W' : e.runs_scored);
                over.runs = e.total_runs;
                over.wickets = e.wickets;
            });

            return (
                <div className="bg-slate-900 rounded-xl border border-slate-800 h-96 flex flex-col">
                    <div className="p-3 border-b border-slate-800 bg-slate-900/50 backdrop-blur font-bold text-slate-400 text-xs uppercase tracking-widest sticky top-0 flex justify-between items-center z-10">
                        <span>Live Commentary</span>
                        <button 
                            onClick={() => setIsAutoScroll(!isAutoScroll)}
                            className={`text-[10px] px-2 py-1 rounded border transition-colors ${isAutoScroll ? 'bg-emerald-500/20 text-emerald-400 border-emerald-500/50' : 'bg-slate-800 text-slate-500 border-slate-700 hover:text-slate-300'}`}
                        >
                            {isAutoScroll ? 'Auto-Scroll: ON' : 'Auto-Scroll: OFF'}
                        </button>
                    </div>
                    <div ref={scrollRef} className="flex-1 overflow-y-auto p-4 scrollbar-hide space-y-3 relative">
                        {events.length === 0 && <div className="text-center text-slate-600 italic mt-32">Waiting for first ball...</div>}
                        {groupedOvers.map((over) => (
                            <div key={over.key} className="p-4 bg-slate-800 rounded-lg border border-slate-700/50 flex items-center justify-between ball-pop shadow-sm">
                                <div className="flex flex-col gap-1 w-24 flex-shrink-0">
                                    <span className="text-emerald-400 font-bold text-sm">Over {over.overNum}</span>
                                    <span className="text-slate-500 text-xs font-bold">{over.team}</span>
                                </div>
                                <div className="flex items-center gap-3 flex-1 justify-end">
                                    <div className="flex gap-1.5 justify-end">
                                        {over.balls.map((b, j) => (
                                            <span key={j} className={`w-6 h-6 flex items-center justify-center rounded text-[10px] font-bold font-mono shadow-sm
                                                ${b === 'W' ? 'bg-rose-500 text-white' : 
                                                  b === 6 ? 'bg-purple-500 text-white' : 
                                                  b === 4 ? 'bg-emerald-500 text-slate-900' : 
                                                  'bg-slate-700 text-slate-300'}`}>
                                                {b}
                                            </span>
                                        ))}
                                    </div>
                                    <div className="w-px h-8 bg-slate-700 mx-1"></div>
                                    <div className="text-right w-16 flex-shrink-0">
                                        <div className="text-white font-mono font-bold text-sm">{over.runs}/{over.wickets}</div>
                                    </div>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const DetailedScorecard = ({ teamName, data }) => {
            if (!data) return null;

            return (
                <div className="mb-8 last:mb-0">
                    <div className="bg-slate-800/80 px-4 py-3 border-b border-slate-700 flex justify-between items-center rounded-t-xl">
                        <div className="flex items-center gap-3">
                            <span className="w-2 h-6 bg-emerald-500 rounded-sm"></span>
                            <span className="font-black text-xl text-white tracking-tight">{teamName}</span>
                        </div>
                        <span className="font-mono font-bold text-2xl text-emerald-400">{data.score}</span>
                    </div>
                    
                    <div className="bg-slate-900 border border-t-0 border-slate-800 rounded-b-xl overflow-hidden p-4">
                        {/* Batting Table */}
                        <div className="mb-8">
                            <h4 className="text-xs font-bold text-slate-500 uppercase tracking-widest mb-2 px-2">Batting</h4>
                            <div className="overflow-x-auto">
                                <table className="score-table">
                                    <thead className="bg-slate-900 border-b border-slate-700">
                                        <tr>
                                            <th className="text-l w-[40%]">Batter</th>
                                            <th className="text-r w-[10%]">R</th>
                                            <th className="text-r w-[10%]">B</th>
                                            <th className="text-c w-[10%]">4s</th>
                                            <th className="text-c w-[10%]">6s</th>
                                            <th className="text-r w-[20%]">SR</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {data.batting && data.batting.map((b, i) => {
                                            const sr = b.balls > 0 ? ((b.runs / b.balls) * 100).toFixed(1) : "0.0";
                                            // Server does not strictly track 4s/6s in the player_stats dict yet, defaults to "-"
                                            const fours = b.fours ?? "-";
                                            const sixes = b.sixes ?? "-";
                                            const didBat = b.balls > 0 || b.out;
                                            
                                            return (
                                                <tr key={i} className={!b.out && b.balls > 0 ? "bg-emerald-900/10" : ""}>
                                                    <td className="text-l">
                                                        <div className="flex flex-col">
                                                            <span className={`${b.out ? 'text-slate-400' : (didBat ? 'text-emerald-400 font-bold' : 'text-slate-500')}`}>
                                                                {b.name} {!b.out && didBat ? '*' : ''}
                                                            </span>
                                                            <span className="text-[10px] text-slate-500 font-normal lowercase">{b.out ? 'out' : (didBat ? 'not out' : '')}</span>
                                                        </div>
                                                    </td>
                                                    <td className="text-r font-bold text-white">{b.runs}</td>
                                                    <td className="text-r text-slate-400">{b.balls}</td>
                                                    <td className="text-c text-slate-500">{fours}</td>
                                                    <td className="text-c text-slate-500">{sixes}</td>
                                                    <td className="text-r text-slate-400 font-mono text-xs">{sr}</td>
                                                </tr>
                                            );
                                        })}
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        {/* Bowling Table */}
                        {data.bowling && data.bowling.length > 0 && (
                            <div>
                                <h4 className="text-xs font-bold text-slate-500 uppercase tracking-widest mb-2 px-2">Bowling</h4>
                                <div className="overflow-x-auto">
                                    <table className="score-table">
                                        <thead className="bg-slate-900 border-b border-slate-700">
                                            <tr>
                                                <th className="text-l w-[40%]">Bowler</th>
                                                <th className="text-c w-[10%]">O</th>
                                                <th className="text-c w-[10%]">M</th>
                                                <th className="text-c w-[10%]">R</th>
                                                <th className="text-c w-[10%]">W</th>
                                                <th className="text-r w-[20%]">Econ</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {data.bowling.map((b, i) => {
                                                // Handle server data mapping: 'runs_given' is the key in server's bowler_stats
                                                const runs = b.runs_given ?? b.runs ?? 0;
                                                const wickets = b.wickets ?? 0;
                                                const maidens = b.maidens ?? 0; 
                                                const balls = b.balls ?? 0;
                                                
                                                // Calculate Overs string (e.g. 3.2) from balls instead of using integer 'overs'
                                                const oversDisplay = `${Math.floor(balls / 6)}.${balls % 6}`;

                                                // Calculate Economy based on actual ball count
                                                const oversFloat = balls / 6;
                                                const econ = oversFloat > 0 ? (runs / oversFloat).toFixed(2) : "0.00";

                                                return (
                                                    <tr key={i}>
                                                        <td className="text-l text-rose-300 font-medium">{b.name}</td>
                                                        <td className="text-c text-slate-300">{oversDisplay}</td>
                                                        <td className="text-c text-slate-500">{maidens}</td>
                                                        <td className="text-c text-slate-300">{runs}</td>
                                                        <td className="text-c font-bold text-white">{wickets}</td>
                                                        <td className="text-r text-slate-400 font-mono text-xs">{econ}</td>
                                                    </tr>
                                                );
                                            })}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const SeriesSummary = ({ data }) => {
            if (!data || !data.summary) return null;

            let summaryText = "";
            let subText = "";

            const parseSummary = (sum) => {
                if (typeof sum === 'object') return sum;
                // Attempt to parse python-style string dictionary (e.g., "{'Team': 1}")
                if (typeof sum === 'string' && sum.trim().startsWith('{')) {
                    try {
                        const jsonString = sum.replace(/'/g, '"');
                        return JSON.parse(jsonString);
                    } catch (e) {
                        return sum;
                    }
                }
                return sum;
            };

            const summaryObj = parseSummary(data.summary);

            if (typeof summaryObj === 'string') {
                summaryText = summaryObj;
            } else if (summaryObj.scoreline) {
                summaryText = summaryObj.scoreline;
            } else {
                // Parse object like {'India': 1, 'Australia': 0, 'Tie': 0}
                const entries = Object.entries(summaryObj).filter(([k]) => k !== 'Tie');
                if (entries.length >= 2) {
                    const [team1, score1] = entries[0];
                    const [team2, score2] = entries[1];
                    const tie = summaryObj['Tie'] || 0;
                    
                    if (score1 > score2) summaryText = `${team1} Wins Series`;
                    else if (score2 > score1) summaryText = `${team2} Wins Series`;
                    else summaryText = "Series Drawn";
                    
                    subText = `${team1} (${score1}) - ${team2} (${score2})` + (tie > 0 ? ` | Ties: ${tie}` : "");
                } else {
                    summaryText = "Series Concluded";
                    subText = JSON.stringify(summaryObj);
                }
            }

            return (
                <div className="bg-gradient-to-r from-emerald-900/40 to-slate-900 border border-emerald-500/30 p-8 rounded-2xl text-center shadow-2xl relative overflow-hidden">
                    <div className="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-emerald-500 to-transparent opacity-50"></div>
                    <h3 className="text-sm font-black text-emerald-500 uppercase tracking-[0.3em] mb-4">Series Summary</h3>
                    <div className="text-3xl md:text-5xl font-black text-white drop-shadow-lg mb-2">
                        {summaryText}
                    </div>
                    {subText && <div className="text-slate-400 font-mono text-lg">{subText}</div>}
                </div>
            );
        };

        const App = () => {
            const [stage, setStage] = useState('setup');
            const [numMatches, setNumMatches] = useState(1);
            const [team1, setTeam1] = useState({ name: "India", players: Array(11).fill("") });
            const [team2, setTeam2] = useState({ name: "Australia", players: Array(11).fill("") });
            const [matchDetail, setMatchDetail] = useState(null);
            const [ballEvents, setBallEvents] = useState([]);
            const [history, setHistory] = useState([]);
            const [seriesComplete, setSeriesComplete] = useState(null);

            const fillDefaults = () => {
                setTeam1({ name: "India", players: ["RG Sharma", "V Kohli", "RR Pant", "SA Yadav", "S Dube", "HH Pandya", "RA Jadeja", "AR Patel", "Kuldeep Yadav", "JJ Bumrah", "Arshdeep Singh"] });
                setTeam2({ name: "Australia", players: ["DA Warner", "TM Head", "MR Marsh", "GJ Maxwell", "MP Stoinis", "TH David", "MS Wade", "PJ Cummins", "MA Starc", "A Zampa", "JR Hazlewood"] });
            };

            const updatePlayer = (tId, idx, v) => {
                if (tId === 1) { const n = [...team1.players]; n[idx] = v; setTeam1({...team1, players: n}); }
                else { const n = [...team2.players]; n[idx] = v; setTeam2({...team2, players: n}); }
            };

            const startSimulation = async () => {
                setStage('live');
                setBallEvents([]);
                setMatchDetail(null);
                setHistory([]);
                setSeriesComplete(null);
                
                try {
                    const response = await fetch('http://127.0.0.1:8000/simulate_series_stream', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            team1_name: team1.name,
                            team1_players: team1.players,
                            team2_name: team2.name,
                            team2_players: team2.players,
                            num_matches: numMatches
                        })
                    });

                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();
                    let buffer = "";

                    const processLine = (line) => {
                        if (!line.trim()) return;
                        try {
                            const data = JSON.parse(line);
                            if (data.type === 'ball') {
                                setMatchDetail(data.detail);
                                setBallEvents(prev => {
                                    const currentMatchNo = data.match_no;
                                    const lastMatchNo = prev.length > 0 ? prev[prev.length - 1].match_no : currentMatchNo;
                                    if (currentMatchNo !== lastMatchNo) {
                                        return [{ ...data.detail, innings: data.innings, match_no: data.match_no }];
                                    }
                                    return [...prev, { ...data.detail, innings: data.innings, match_no: data.match_no }];
                                });
                            } else if (data.type === 'match_update') {
                                setHistory(prev => [data, ...prev]);
                            } else if (data.type === 'series_complete') {
                                setSeriesComplete(data);
                            }
                        } catch (e) {
                            console.error("Error parsing JSON line:", line, e);
                        }
                    };

                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;
                        const chunk = decoder.decode(value, { stream: true });
                        buffer += chunk;
                        const lines = buffer.split('\n');
                        buffer = lines.pop(); 
                        lines.forEach(processLine);
                    }
                    if (buffer.trim()) processLine(buffer);
                } catch (err) {
                    console.error("Simulation Error:", err);
                    alert("Simulation failure. Check console.");
                    setStage('setup');
                }
            };

            if (stage === 'predict') {
                return <BallPredictor onBack={() => setStage('setup')} />;
            }
            
            if (stage === 'setup') return (
                <div className="min-h-screen p-8 max-w-6xl mx-auto">
                    <header className="mb-12 text-center">
                        <h1 className="text-5xl font-black bg-gradient-to-r from-emerald-400 to-cyan-500 bg-clip-text text-transparent tracking-tight">CRICKET SERIES SIMULATOR</h1>
                    </header>
                    <div className="grid md:grid-cols-2 gap-12">
                        <div className="space-y-4">
                            <input value={team1.name} onChange={e => setTeam1({...team1, name: e.target.value})} className="w-full bg-transparent text-2xl font-bold border-b-2 border-slate-700 focus:border-emerald-500 outline-none pb-2 text-emerald-400" placeholder="Team 1" />
                            {team1.players.map((p, i) => <PlayerInput key={i} value={p} onChange={v => updatePlayer(1, i, v)} placeholder={`Player ${i+1}`} />)}
                        </div>
                        <div className="space-y-4 text-right">
                            <input value={team2.name} onChange={e => setTeam2({...team2, name: e.target.value})} className="w-full bg-transparent text-2xl font-bold border-b-2 border-slate-700 focus:border-rose-500 outline-none pb-2 text-rose-400 text-right" placeholder="Team 2" />
                            {team2.players.map((p, i) => <PlayerInput key={i} value={p} onChange={v => updatePlayer(2, i, v)} placeholder={`Player ${i+1}`} />)}
                        </div>
                    </div>
                    <div className="mt-16 flex flex-col items-center gap-6">
                        <div className="flex items-center gap-4 bg-slate-800 p-3 rounded-xl border border-slate-700">
                            <span className="text-slate-400 font-bold">Games:</span>
                            <input type="number" value={numMatches} onChange={e => setNumMatches(Math.max(1, parseInt(e.target.value) || 1))} className="bg-slate-900 w-16 p-1 text-center font-bold text-emerald-400 border border-slate-700 rounded text-white" />
                        </div>
                        <div className="flex gap-4">
                            <button onClick={fillDefaults} className="px-8 py-3 rounded-xl text-slate-400 border border-slate-700 font-bold hover:bg-slate-800 transition">Quick Fill</button>
                            <button onClick={startSimulation} className="px-12 py-3 rounded-xl bg-emerald-500 text-slate-900 font-black hover:scale-105 transition shadow-[0_0_20px_rgba(16,185,129,0.4)]">START SERIES</button>
                        </div>
                         <button onClick={() => setStage('predict')} className="mt-4 px-6 py-2 rounded-lg bg-gradient-to-r from-purple-500/20 to-pink-500/20 text-purple-300 font-bold border border-purple-500/30 hover:border-purple-500 hover:text-white transition flex items-center gap-2">
                             <i data-lucide="brain-circuit" className="w-4 h-4"></i> AI PREDICTOR
                        </button>
                    </div>
                </div>
            );

            return (
                <div className="min-h-screen p-6 bg-slate-950 flex flex-col items-center">
                    {/* Header Bar */}
                    <div className="w-full max-w-6xl flex justify-between items-center mb-6">
                        <button onClick={() => setStage('setup')} className="text-xs font-bold text-slate-500 hover:text-white flex items-center gap-2 px-4 py-2 rounded-full bg-slate-900 border border-slate-800 transition hover:border-slate-600">
                            <i data-lucide="arrow-left" className="w-4 h-4"></i> BACK TO SETUP
                        </button>
                        {seriesComplete && <div className="text-emerald-400 font-black animate-pulse uppercase tracking-widest text-xs border border-emerald-500/20 px-3 py-1 rounded bg-emerald-500/5">Series Concluded</div>}
                    </div>

                    <div className="w-full max-w-6xl grid lg:grid-cols-2 gap-8">
                        
                        {/* LEFT COLUMN: LIVE ACTION (1/2 width) */}
                        <div className="space-y-6">
                            {/* Loading State */}
                            {!matchDetail && !seriesComplete && (
                                <div className="flex flex-col items-center justify-center h-96 text-slate-500 animate-pulse bg-slate-900/50 rounded-2xl border border-slate-800 border-dashed">
                                    <div className="text-6xl mb-6"></div>
                                    <div className="font-mono text-sm uppercase tracking-widest text-emerald-500">Initializing Pitch...</div>
                                    <div className="text-xs text-slate-600 mt-2">Tossing coin... Checking field...</div>
                                </div>
                            )}

                            <ScoreCardLive detail={matchDetail} live={!seriesComplete} />
                        </div>

                        {/* RIGHT COLUMN: COMMENTARY (1/2 width) */}
                        <div className="">
                             <Commentary events={ballEvents} />
                        </div>
                    </div>

                    {/* FULL WIDTH BOTTOM SECTION: MATCH HISTORY / SCORECARDS */}
                    <div className="w-full max-w-6xl mt-12 space-y-8">
                        {seriesComplete && <SeriesSummary data={seriesComplete} />}

                        {history.length > 0 && (
                            <div>
                                <h2 className="text-xl font-black text-slate-300 uppercase tracking-wider mb-6 flex items-center gap-3">
                                    <i data-lucide="history" className="w-6 h-6 text-slate-500"></i> Match History
                                </h2>
                                
                                <div className="grid gap-12">
                                    {history.map((m, idx) => (
                                        <div key={idx} className="bg-slate-950 rounded-2xl border border-slate-800 p-1 shadow-2xl">
                                            {/* Match Header */}
                                            <div className="bg-slate-900 p-4 rounded-t-xl flex justify-between items-center border-b border-slate-800">
                                                <span className="font-bold text-slate-400">Match {history.length - idx}</span>
                                                <div className="text-right">
                                                    <div className="text-emerald-400 font-bold">{m.winner} Won</div>
                                                    <div className="text-xs text-slate-500">by {m.margin}</div>
                                                </div>
                                            </div>
                                            
                                            {/* Scorecards Container */}
                                            <div className="p-4 md:p-6 grid lg:grid-cols-2 gap-8">
                                                {m.scorecard && Object.entries(m.scorecard).map(([name, data]) => (
                                                    <DetailedScorecard key={name} teamName={name} data={data} />
                                                ))}
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
        // Initialize icons after render
        setTimeout(() => lucide.createIcons(), 100);
    </script>
</body>
</html>